function polarTensor = integratePolarizability(wfnGrid,ini,fin,phi,theta,da,Ngrid,polarTensorGrid4d)  ds1 = sin(theta)*2*da^2;  ds1(ds1==0) = 0.00000001;    ds = kron(ds1,ds1);  ds(ds==0) = 0.00000001;  dsDiag = diag(reshape(ds,[Ngrid^4,1]));    polarTensorGrid = reshape(polarTensorGrid4d,3,3,Ngrid^4);%reshape the 4d polarisation tensor into a 2d matrix     polarTensorGridDiag11 = diag(permute(polarTensorGrid(1,1,:),[3,1,2]));  polarTensor(1,1) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag11)*transpose(wfnGrid(ini,:));    polarTensorGridDiag12 = diag(permute(polarTensorGrid(1,2,:),[3,1,2]));  polarTensor(1,2) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag12)*transpose(wfnGrid(ini,:));    polarTensorGridDiag13 = diag(permute(polarTensorGrid(1,3,:),[3,1,2]));  polarTensor(1,3) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag13)*transpose(wfnGrid(ini,:));    polarTensorGridDiag21 = diag(permute(polarTensorGrid(2,1,:),[3,1,2]));  polarTensor(2,1) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag21)*transpose(wfnGrid(ini,:));    polarTensorGridDiag22 = diag(permute(polarTensorGrid(2,2,:),[3,1,2]));  polarTensor(2,2) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag22)*transpose(wfnGrid(ini,:));    polarTensorGridDiag23 = diag(permute(polarTensorGrid(2,3,:),[3,1,2]));  polarTensor(2,3) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag23)*transpose(wfnGrid(ini,:));      polarTensorGridDiag31 = diag(permute(polarTensorGrid(3,1,:),[3,1,2]));  polarTensor(3,1) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag31)*transpose(wfnGrid(ini,:));    polarTensorGridDiag32 = diag(permute(polarTensorGrid(3,2,:),[3,1,2]));  polarTensor(3,2) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag32)*transpose(wfnGrid(ini,:));    polarTensorGridDiag33 = diag(permute(polarTensorGrid(3,3,:),[3,1,2]));  polarTensor(3,3) = conj(wfnGrid(fin,:))*(dsDiag*polarTensorGridDiag33)*transpose(wfnGrid(ini,:));    end